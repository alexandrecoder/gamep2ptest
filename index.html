<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat P2P com WebRTC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        textarea {
            resize: none;
        }
        #chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }
        #chat-messages::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .connection-box {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center h-full antialiased p-4">

    <!-- Container de Conexão -->
    <div id="connection-container" class="bg-white p-8 rounded-2xl shadow-lg max-w-2xl w-full">
        <h1 class="text-2xl font-bold text-slate-800 mb-2 text-center">Chat P2P (ponta-a-ponta)</h1>
        <p class="text-slate-600 mb-6 text-center">Para conectar, troque os códigos de sessão manualmente.</p>

        <div class="grid md:grid-cols-2 gap-6">
            <!-- Lado 1: Criar Sessão -->
            <div class="connection-box p-6 rounded-lg">
                <h2 class="text-lg font-semibold text-slate-700 mb-4">1. Para Iniciar uma Conversa</h2>
                <button id="create-offer-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Gerar Convite</button>
                <div class="mt-4">
                    <label for="offer-sdp" class="block text-sm font-medium text-slate-600 mb-1">Seu Convite:</label>
                    <textarea id="offer-sdp" rows="4" class="w-full p-2 border border-slate-300 rounded-md bg-slate-50" readonly placeholder="Seu código de convite aparecerá aqui..."></textarea>
                </div>
                <div class="mt-4">
                    <label for="answer-sdp-input" class="block text-sm font-medium text-slate-600 mb-1">Cole a Resposta Recebida:</label>
                    <textarea id="answer-sdp-input" rows="4" class="w-full p-2 border border-slate-300 rounded-md" placeholder="Cole a resposta do outro usuário aqui..."></textarea>
                </div>
                <button id="connect-btn" class="w-full mt-4 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Conectar</button>
            </div>

            <!-- Lado 2: Entrar em uma Sessão -->
            <div class="connection-box p-6 rounded-lg">
                <h2 class="text-lg font-semibold text-slate-700 mb-4">2. Para Entrar em uma Conversa</h2>
                <div class="mt-4">
                    <label for="offer-sdp-input" class="block text-sm font-medium text-slate-600 mb-1">Cole o Convite Recebido:</label>
                    <textarea id="offer-sdp-input" rows="4" class="w-full p-2 border border-slate-300 rounded-md" placeholder="Cole o convite do outro usuário aqui..."></textarea>
                </div>
                <button id="create-answer-btn" class="w-full mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Gerar Resposta</button>
                <div class="mt-4">
                    <label for="answer-sdp" class="block text-sm font-medium text-slate-600 mb-1">Sua Resposta:</label>
                    <textarea id="answer-sdp" rows="4" class="w-full p-2 border border-slate-300 rounded-md bg-slate-50" readonly placeholder="Sua resposta para enviar de volta aparecerá aqui..."></textarea>
                </div>
            </div>
        </div>
        <p id="status" class="text-center mt-6 text-slate-500 font-medium">Status: Aguardando conexão...</p>
    </div>

    <!-- Container do Chat (inicialmente oculto) -->
    <div id="chat-container" class="hidden flex flex-col h-[95vh] w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden">
        <header class="bg-slate-50 border-b border-slate-200 p-4 flex items-center justify-between">
            <h1 class="text-xl font-bold text-slate-800">Chat P2P Conectado</h1>
            <p id="connection-status" class="text-sm font-semibold text-green-600">● Online</p>
        </header>
        <main id="chat-messages" class="flex-1 p-6 overflow-y-auto space-y-4 bg-slate-100">
            <!-- Mensagens do chat aqui -->
        </main>
        <footer class="bg-slate-50 border-t border-slate-200 p-4">
            <form id="message-form" class="flex items-center space-x-4">
                <input type="text" id="message-input" placeholder="Digite sua mensagem..." class="flex-1 px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" autocomplete="off" required>
                <button type="submit" class="bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all duration-200">Enviar</button>
            </form>
        </footer>
    </div>

    <script type="module">
        // --- Configuração e Variáveis Globais ---
        let peerConnection;
        let dataChannel;

        // Configuração dos servidores STUN (necessário para descobrir o IP público e atravessar NATs)
        // Usamos servidores públicos e gratuitos do Google. Isso não é um "servidor de aplicação".
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // --- Referências do DOM ---
        const connectionContainer = document.getElementById('connection-container');
        const chatContainer = document.getElementById('chat-container');
        const createOfferBtn = document.getElementById('create-offer-btn');
        const connectBtn = document.getElementById('connect-btn');
        const createAnswerBtn = document.getElementById('create-answer-btn');
        const offerSdpTextarea = document.getElementById('offer-sdp');
        const answerSdpTextarea = document.getElementById('answer-sdp');
        const offerSdpInput = document.getElementById('offer-sdp-input');
        const answerSdpInput = document.getElementById('answer-sdp-input');
        const statusEl = document.getElementById('status');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const chatMessages = document.getElementById('chat-messages');

        // --- Lógica do WebRTC ---

        function initializePeerConnection() {
            peerConnection = new RTCPeerConnection(configuration);

            // Listener para candidatos ICE. Precisamos esperar todos serem coletados.
            peerConnection.onicecandidate = event => {
                if (event.candidate === null) {
                    // Todos os candidatos foram coletados. O SDP local está pronto.
                    const sdp = JSON.stringify(peerConnection.localDescription);
                    if (peerConnection.localDescription.type === 'offer') {
                        offerSdpTextarea.value = sdp;
                        statusEl.textContent = 'Convite gerado. Copie e envie para o outro usuário.';
                    } else if (peerConnection.localDescription.type === 'answer') {
                        answerSdpTextarea.value = sdp;
                        statusEl.textContent = 'Resposta gerada. Copie e envie de volta para quem iniciou.';
                    }
                }
            };

            // Listener para quando a conexão é estabelecida
            peerConnection.onconnectionstatechange = () => {
                if (peerConnection.connectionState === 'connected') {
                    showChatView();
                }
                 if (peerConnection.connectionState === 'failed' || peerConnection.connectionState === 'disconnected') {
                    alert('Conexão perdida. Por favor, reinicie o processo.');
                    resetApp();
                }
            };

            // Listener para o canal de dados (para quem recebe a conexão)
            peerConnection.ondatachannel = event => {
                dataChannel = event.channel;
                setupDataChannelEvents();
            };
        }

        function setupDataChannelEvents() {
            dataChannel.onopen = () => console.log('Canal de dados aberto!');
            dataChannel.onclose = () => console.log('Canal de dados fechado!');
            dataChannel.onmessage = event => {
                displayMessage(event.data, 'other');
            };
        }

        // --- Manipuladores de Eventos da UI ---

        // 1. Quem cria a oferta (inicia a conversa)
        createOfferBtn.addEventListener('click', async () => {
            initializePeerConnection();
            // O iniciador cria o canal de dados
            dataChannel = peerConnection.createDataChannel('chat');
            setupDataChannelEvents();
            
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            statusEl.textContent = 'Gerando convite...';
        });

        // 2. Quem recebe a oferta e cria a resposta
        createAnswerBtn.addEventListener('click', async () => {
            if (!offerSdpInput.value) return alert('Por favor, cole o convite primeiro.');
            
            initializePeerConnection();
            
            const offer = JSON.parse(offerSdpInput.value);
            await peerConnection.setRemoteDescription(offer);
            
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            statusEl.textContent = 'Gerando resposta...';
        });

        // 3. Quem iniciou a conversa finaliza a conexão com a resposta
        connectBtn.addEventListener('click', async () => {
            if (!answerSdpInput.value) return alert('Por favor, cole a resposta primeiro.');
            
            const answer = JSON.parse(answerSdpInput.value);
            await peerConnection.setRemoteDescription(answer);
            statusEl.textContent = 'Conectando...';
        });

        // 4. Envio de mensagens
        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message && dataChannel.readyState === 'open') {
                dataChannel.send(message);
                displayMessage(message, 'self');
                messageInput.value = '';
            }
        });

        // --- Funções Auxiliares ---

        function displayMessage(text, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${sender === 'self' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = 'max-w-md lg:max-w-lg p-3 rounded-2xl shadow-md';
            messageBubble.classList.add(
                sender === 'self' 
                ? 'bg-blue-600 text-white rounded-br-lg' 
                : 'bg-white text-slate-800 rounded-bl-lg'
            );
            messageBubble.textContent = text;
            
            messageWrapper.appendChild(messageBubble);
            chatMessages.appendChild(messageWrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showChatView() {
            connectionContainer.classList.add('hidden');
            chatContainer.classList.remove('hidden');
            chatContainer.classList.add('flex');
            messageInput.focus();
        }
        
        function resetApp() {
            connectionContainer.classList.remove('hidden');
            chatContainer.classList.add('hidden');
            chatContainer.classList.remove('flex');
            offerSdpTextarea.value = '';
            answerSdpTextarea.value = '';
            offerSdpInput.value = '';
            answerSdpInput.value = '';
            statusEl.textContent = 'Status: Aguardando conexão...';
            if (peerConnection) {
                peerConnection.close();
            }
        }
    </script>
</body>
</html>
